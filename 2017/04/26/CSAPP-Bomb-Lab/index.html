<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>CSAPP: Bomb Lab | tinylcy</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CSAPP: Bomb Lab</h1><a id="logo" href="/.">tinylcy</a><p class="description">辰洋的博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/timeline/"><i class="fa fa-envira"> 时间线</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="https://github.com/tinylcy"><i class="fa fa-github"> GitHub</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><link rel="stylesheet" type="text/css" href="/css/reward.css"></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CSAPP: Bomb Lab</h1><div class="post-meta">Apr 26, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/04/26/CSAPP-Bomb-Lab/" href="/2017/04/26/CSAPP-Bomb-Lab/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Phase-1"><span class="toc-number">1.</span> <span class="toc-text">Phase 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phase-2"><span class="toc-number">2.</span> <span class="toc-text">Phase 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phase-3"><span class="toc-number">3.</span> <span class="toc-text">Phase 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phase-4"><span class="toc-number">4.</span> <span class="toc-text">Phase 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phase-5"><span class="toc-number">5.</span> <span class="toc-text">Phase 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phase-6"><span class="toc-number">6.</span> <span class="toc-text">Phase 6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">7.</span> <span class="toc-text">小结</span></a></li></ol></div></div><div class="post-content"><p><code>Bomb Lab</code>是<code>CS:APP</code>一书中第二个<a href="http://csapp.cs.cmu.edu/3e/bomblab.pdf" target="_blank" rel="external">实验</a>，实验中的<code>bomb</code>实际上是一个程序的二进制文件，该程序由一系列<code>phase</code>组成，每个<code>phase</code>需要我们输入一个字符串，然后该程序会进行校验，如果输入的字符串不满足拆弹要求，那么就会打印<code>BOOM!!!</code>。</p>
<a id="more"></a>
<p>完成整个实验的思路是通过<code>objdump</code>对<code>bome</code>进行反编译（<code>objdump -d bomb &gt; bomb.txt</code>），获取所有的汇编代码。提取每个阶段对应的代码并借助<code>gdb</code>进行分析，逐一拆弹。</p>
<h2 id="Phase-1"><a href="#Phase-1" class="headerlink" title="Phase 1"></a>Phase 1</h2><p><code>phase_1</code>对应的代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">0000000000400ee0 &lt;phase_1&gt;:</div><div class="line">  400ee0: 48 83 ec 08           sub    $0x8,%rsp</div><div class="line">  400ee4: be 00 24 40 00        mov    $0x402400,%esi</div><div class="line">  400ee9: e8 4a 04 00 00        callq  401338 &lt;strings_not_equal&gt;</div><div class="line">  400eee: 85 c0                 test   %eax,%eax</div><div class="line">  400ef0: 74 05                 je     400ef7 &lt;phase_1+0x17&gt;</div><div class="line">  400ef2: e8 43 05 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  400ef7: 48 83 c4 08           add    $0x8,%rsp</div><div class="line">  400efb: c3                    retq</div></pre></td></tr></table></figure>
<p>由<code>callq</code>指令可以得知，<code>phase_1</code>调用了<code>strings_not_equal</code>，并将返回值存储于<code>%eax</code>中，<code>test</code>指令计算<code>%eax</code>的值是否等于<code>0</code>，<code>je</code>指令决定是否跳转，若<code>%eax</code>的值等于<code>0</code>，则跳转至<code>0x400ef7</code>处，也就是安全区域，拆弹成功，否则不跳转，即执行<code>explode_bomb</code>，拆弹失败。通过以上分析，可以得知<code>phase_1</code>的关键在于控制<code>strings_not_equal</code>的返回值。</p>
<p>在执行<code>callq strings_not_equal</code>指令之前，<code>mov $0x402400,%esi</code>将常数<code>0x402400</code>传递至<code>%esi</code>，根据<code>x86-64</code>寄存器使用规范，<code>%esi</code>的值是<code>strings_not_equal</code>函数的第二个参数，而第一个参数则是我们输入的值。因此，问题的关键在于如何得到<code>%esi</code>的值。</p>
<p>利用<code>gdb</code>对<code>bomb</code>进行调试，并在<code>phase_1</code>处设置断点，通过<code>disassemble</code>对当前函数进行反编译，使用<code>stepi</code>对指令进行单步调试，运行至<code>phase_1</code>第一条指令的初始状态如下图所示。</p>
<p><img src="/img/2017-04-26-Image 1.png" alt=""></p>
<p>在进入<code>phase_1</code>之前，<code>read_line</code>函数从终端读取输入（可从<code>bomb.c</code>得知该信息，我输入的是<code>tinylcy</code>）。接着，通过<code>stepi</code>单步执行指令，直至指令<code>mov $0x402400,%esi</code>执行完毕，如下图所示。</p>
<p><img src="/img/2017-04-26-Image 2.png" alt=""></p>
<p>此时，<code>strings_not_equal</code>函数的第二个参数已经存储于<code>%esi</code>，通过<code>print</code>打印<code>%esi</code>的值，可以得知<code>%esi</code>存储的是一个内存地址，这是因为参数类型是字符串类型，因此寄存器存储的是内存地址，而非确切的字符串值，使用<code>x</code>打印位于地址<code>%esi</code>处的内容，如下图所示。</p>
<p><img src="/img/2017-04-26-Image 3.png" alt=""></p>
<p>由此，我们得到了拆除<code>pahse_1</code>炸弹所需要的字符串。</p>
<h2 id="Phase-2"><a href="#Phase-2" class="headerlink" title="Phase 2"></a>Phase 2</h2><p><code>phase_2</code>对应的代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">0000000000400efc &lt;phase_2&gt;:</div><div class="line">  400efc: 55                    push   %rbp</div><div class="line">  400efd: 53                    push   %rbx</div><div class="line">  400efe: 48 83 ec 28           sub    $0x28,%rsp</div><div class="line">  400f02: 48 89 e6              mov    %rsp,%rsi</div><div class="line">  400f05: e8 52 05 00 00        callq  40145c &lt;read_six_numbers&gt;</div><div class="line">  400f0a: 83 3c 24 01           cmpl   $0x1,(%rsp)</div><div class="line">  400f0e: 74 20                 je     400f30 &lt;phase_2+0x34&gt;</div><div class="line">  400f10: e8 25 05 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  400f15: eb 19                 jmp    400f30 &lt;phase_2+0x34&gt;</div><div class="line">  400f17: 8b 43 fc              mov    -0x4(%rbx),%eax</div><div class="line">  400f1a: 01 c0                 add    %eax,%eax</div><div class="line">  400f1c: 39 03                 cmp    %eax,(%rbx)</div><div class="line">  400f1e: 74 05                 je     400f25 &lt;phase_2+0x29&gt;</div><div class="line">  400f20: e8 15 05 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  400f25: 48 83 c3 04           add    $0x4,%rbx</div><div class="line">  400f29: 48 39 eb              cmp    %rbp,%rbx</div><div class="line">  400f2c: 75 e9                 jne    400f17 &lt;phase_2+0x1b&gt;</div><div class="line">  400f2e: eb 0c                 jmp    400f3c &lt;phase_2+0x40&gt;</div><div class="line">  400f30: 48 8d 5c 24 04        lea    0x4(%rsp),%rbx</div><div class="line">  400f35: 48 8d 6c 24 18        lea    0x18(%rsp),%rbp</div><div class="line">  400f3a: eb db                 jmp    400f17 &lt;phase_2+0x1b&gt;</div><div class="line">  400f3c: 48 83 c4 28           add    $0x28,%rsp</div><div class="line">  400f40: 5b                    pop    %rbx</div><div class="line">  400f41: 5d                    pop    %rbp</div><div class="line">  400f42: c3                    retq</div></pre></td></tr></table></figure>
<p>由<code>callq read_six_numbers</code>可知，<code>phase_2</code>调用了<code>read_six_numbers</code>函数并读取了<code>6</code>个数值。根据<code>cmpl $0x1,(%rsp)</code>可知，若地址<code>%rsp</code>处的值等于<code>1</code>，那么进入安全区域，否则就会引爆炸弹。由此可以得知，我们输入的第<code>1</code>个数字应该为<code>1</code>。然后<code>phase_2</code>跳转至<code>0x400f30</code>处执行指令<code>lea 0x4(%rsp),%rbx</code>，该指令的效果是将<code>%rsp</code>的值加<code>4</code>并存储于<code>%rbx</code>，这意味着<code>%rbx</code>的值实际上是下一个数的地址值。<code>lea 0x18(%rsp),%rbp</code>用于控制循环的次数，<code>6</code>个整型共占用<code>24</code>字节，恰好等于<code>0x18</code>。接着<code>phase_2</code>跳转至<code>0x400f17</code>处执行<code>mov -0x4(%rbx),%eax</code>指令，该指令的效果是使<code>%eax</code>的值等于<code>M[%rbx-4]</code>的值，即<code>M[%rsp]</code>的值，也就是第<code>1</code>个数的值。<code>add %eax,%eax</code>使<code>%eax</code>的值扩大为原来的<code>2</code>倍，<code>cmp %eax,(%rbx)</code>将下一个数的值与<code>%eax</code>的值作比较，若相等则跳转至安全区域<code>0x400f25</code>，否则拆弹失败。<code>0x400f25</code>处的指令为<code>add $0x4,%rbx</code>，该指令的效果是使<code>%rbx</code>存储下一个数的地址，与<code>%rbp</code>的值比较并在不相等的情况下跳转至<code>0x400f17</code>处循环执行指令。</p>
<p>综上，<code>phase_2</code>通过<code>%rbx</code>来获取输入的<code>6</code>个数字，通过<code>%eax</code>来控制比较的数值大小，<code>%eax</code>初始化为第<code>1</code>个数字的值，并在每次循环后增长至原来的<code>2</code>倍，一共<code>6</code>次循环。所以<code>phase_2</code>的解为<code>1 2 4 8 16 32</code>。</p>
<h2 id="Phase-3"><a href="#Phase-3" class="headerlink" title="Phase 3"></a>Phase 3</h2><p><code>phase_3</code>对应的代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">0000000000400f43 &lt;phase_3&gt;:</div><div class="line">  400f43: 48 83 ec 18           sub    $0x18,%rsp</div><div class="line">  400f47: 48 8d 4c 24 0c        lea    0xc(%rsp),%rcx</div><div class="line">  400f4c: 48 8d 54 24 08        lea    0x8(%rsp),%rdx</div><div class="line">  400f51: be cf 25 40 00        mov    $0x4025cf,%esi</div><div class="line">  400f56: b8 00 00 00 00        mov    $0x0,%eax</div><div class="line">  400f5b: e8 90 fc ff ff        callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</div><div class="line">  400f60: 83 f8 01              cmp    $0x1,%eax</div><div class="line">  400f63: 7f 05                 jg     400f6a &lt;phase_3+0x27&gt;</div><div class="line">  400f65: e8 d0 04 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  400f6a: 83 7c 24 08 07        cmpl   $0x7,0x8(%rsp)</div><div class="line">  400f6f: 77 3c                 ja     400fad &lt;phase_3+0x6a&gt;</div><div class="line">  400f71: 8b 44 24 08           mov    0x8(%rsp),%eax</div><div class="line">  400f75: ff 24 c5 70 24 40 00  jmpq   *0x402470(,%rax,8)</div><div class="line">  400f7c: b8 cf 00 00 00        mov    $0xcf,%eax</div><div class="line">  400f81: eb 3b                 jmp    400fbe &lt;phase_3+0x7b&gt;</div><div class="line">  400f83: b8 c3 02 00 00        mov    $0x2c3,%eax</div><div class="line">  400f88: eb 34                 jmp    400fbe &lt;phase_3+0x7b&gt;</div><div class="line">  400f8a: b8 00 01 00 00        mov    $0x100,%eax</div><div class="line">  400f8f: eb 2d                 jmp    400fbe &lt;phase_3+0x7b&gt;</div><div class="line">  400f91: b8 85 01 00 00        mov    $0x185,%eax</div><div class="line">  400f96: eb 26                 jmp    400fbe &lt;phase_3+0x7b&gt;</div><div class="line">  400f98: b8 ce 00 00 00        mov    $0xce,%eax</div><div class="line">  400f9d: eb 1f                 jmp    400fbe &lt;phase_3+0x7b&gt;</div><div class="line">  400f9f: b8 aa 02 00 00        mov    $0x2aa,%eax</div><div class="line">  400fa4: eb 18                 jmp    400fbe &lt;phase_3+0x7b&gt;</div><div class="line">  400fa6: b8 47 01 00 00        mov    $0x147,%eax</div><div class="line">  400fab: eb 11                 jmp    400fbe &lt;phase_3+0x7b&gt;</div><div class="line">  400fad: e8 88 04 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  400fb2: b8 00 00 00 00        mov    $0x0,%eax</div><div class="line">  400fb7: eb 05                 jmp    400fbe &lt;phase_3+0x7b&gt;</div><div class="line">  400fb9: b8 37 01 00 00        mov    $0x137,%eax</div><div class="line">  400fbe: 3b 44 24 0c           cmp    0xc(%rsp),%eax</div><div class="line">  400fc2: 74 05                 je     400fc9 &lt;phase_3+0x86&gt;</div><div class="line">  400fc4: e8 71 04 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  400fc9: 48 83 c4 18           add    $0x18,%rsp</div><div class="line">  400fcd: c3                    retq</div></pre></td></tr></table></figure>
<p>前<code>3</code>条指令非常普通，并不能吸引我们的注意，能够吸引我们的是<code>mov $0x4025cf,%esi</code>这条指令，常数<code>0x4025cf</code>应该是个内存地址，打印该内存地址的值，如下图所示。</p>
<p><img src="/img/2017-04-26-Image 4.png" alt=""></p>
<p>很容易把<code>%d %d</code>与<code>callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</code>这条指令联系起来，由此我们基本知道，<code>phase_3</code>会输入<code>2</code>个值。<code>scanf</code>函数的返回值存储于<code>%eax</code>，该值代表输入值的个数，<code>cmp $0x1,%eax</code>将<code>%eax</code>的值与<code>1</code>做比较，如果输入值的个数大于<code>1</code>，跳转至安全区域，即指令<code>cmpl $0x7,0x8(%rsp)</code>处，否则拆弹失败。<code>cmpl   $0x7,0x8(%rsp)</code>将输入的第一个数(以<code>6</code>为例)与<code>7</code>作比较，如果大于<code>7</code>，那么拆弹失败，否则执行指令<code>mov 0x8(%rsp),%eax</code>，该指令将第一个数存储于<code>%eax</code>中。接着执行指令<code>jmpq *0x402470(,%rax,8)</code>，该指令是一个间接跳转指令，通过<code>gdb</code>得到执行该指令后的跳转位置，如下图所示。</p>
<p><img src="/img/2017-04-26-Image 5.png" alt=""></p>
<p><code>mov $0x2aa,%eax</code>指令将常数<code>0x2aa</code>移至<code>%eax</code>，然后执行<code>jmp 0x400fbe &lt;phase_3+123&gt;</code>跳转至<code>0x400fbe</code>处执行指令<code>cmp 0xc(%rsp),%eax</code>，该指令将第二个数与<code>%eax</code>做比较，若相等，安全退出，拆弹成功，否则拆弹失败。<code>0x2aa</code>的十进制值为<code>682</code>，因此<code>phase_3</code>输入的两个数应为<code>6</code>，<code>682</code>。</p>
<p>注意，第一个数并不一定是<code>6</code>，只要小于<code>7</code>即可。当第一个数的取值改变，那么在获取第二个数时会跳转到不同的分支，因此会得到不同的值。例如当第一个数等于<code>5</code>，那么第二个数应为<code>206</code>。</p>
<h2 id="Phase-4"><a href="#Phase-4" class="headerlink" title="Phase 4"></a>Phase 4</h2><p><code>phase_4</code>对应的代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">000000000040100c &lt;phase_4&gt;:</div><div class="line">  40100c: 48 83 ec 18           sub    $0x18,%rsp</div><div class="line">  401010: 48 8d 4c 24 0c        lea    0xc(%rsp),%rcx</div><div class="line">  401015: 48 8d 54 24 08        lea    0x8(%rsp),%rdx</div><div class="line">  40101a: be cf 25 40 00        mov    $0x4025cf,%esi</div><div class="line">  40101f: b8 00 00 00 00        mov    $0x0,%eax</div><div class="line">  401024: e8 c7 fb ff ff        callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</div><div class="line">  401029: 83 f8 02              cmp    $0x2,%eax</div><div class="line">  40102c: 75 07                 jne    401035 &lt;phase_4+0x29&gt;</div><div class="line">  40102e: 83 7c 24 08 0e        cmpl   $0xe,0x8(%rsp)</div><div class="line">  401033: 76 05                 jbe    40103a &lt;phase_4+0x2e&gt;</div><div class="line">  401035: e8 00 04 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  40103a: ba 0e 00 00 00        mov    $0xe,%edx</div><div class="line">  40103f: be 00 00 00 00        mov    $0x0,%esi</div><div class="line">  401044: 8b 7c 24 08           mov    0x8(%rsp),%edi</div><div class="line">  401048: e8 81 ff ff ff        callq  400fce &lt;func4&gt;</div><div class="line">  40104d: 85 c0                 test   %eax,%eax</div><div class="line">  40104f: 75 07                 jne    401058 &lt;phase_4+0x4c&gt;</div><div class="line">  401051: 83 7c 24 0c 00        cmpl   $0x0,0xc(%rsp)</div><div class="line">  401056: 74 05                 je     40105d &lt;phase_4+0x51&gt;</div><div class="line">  401058: e8 dd 03 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  40105d: 48 83 c4 18           add    $0x18,%rsp</div><div class="line">  401061: c3                    retq</div></pre></td></tr></table></figure>
<p>和<code>phase_3</code>类似，首先将内存地址为<code>0x4025cf</code>的内容打印出来，如下图所示。</p>
<p><img src="/img/2017-04-26-Image 6.png" alt=""></p>
<p>由此得知，<code>phase_4</code>的输入应该为<code>2</code>个整数。在执行<code>callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</code>指令后，返回值存储于<code>%eax</code>，然后判断<code>%eax</code>的值是否等于<code>2</code>，若不等于则会引爆炸弹，否则执行指令<code>cmpl $0xe,0x8(%rsp)</code>，该指令将输入的第一个数与常数<code>0xe</code>做比较，根据<code>jbe 40103a &lt;phase_4+0x2e&gt;</code>，如果输入的第一个数大于<code>0xe</code>，那么拆弹失败，否则跳转到<code>0x40103a</code>处执行<code>mov $0xe,%edx</code>指令。接下来可以看到<code>phase_4</code>调用了函数<code>func4</code>，而<code>mov $0xe,%edx</code>、<code>mov $0x0,%esi</code>和<code>mov 0x8(%rsp),%edi</code>这三条指令用于设置<code>func4</code>的参数，根据<code>x86-64</code>寄存器使用规范，第一个、第二个和第三个参数分别存储于寄存器<code>%edi</code>、<code>%esi</code>和<code>%edx</code>。</p>
<p>在查看<code>func4</code>对应的代码之前，先观察执行<code>callq  400fce &lt;func4&gt;</code>指令之后<code>phase_4</code>的操作：<code>test %eax,%eax</code>指令检查<code>%eax</code>的值是否等于<code>0</code>，如果不等于<code>0</code>，则会引爆炸弹，否则执行指令<code>cmpl $0x0,0xc(%rsp)</code>，该指令将输入的第二个数与<code>0</code>做比较，如果相等，那么<code>phase_4</code>正常退出，拆弹成功。因此，<code>phase_4</code>的第二个输入值即为<code>0</code>。</p>
<p>经过以上的分析，可以意识到<code>phase_4</code>的核心目标在于要让<code>func4</code>执行后，<code>%eax</code>的值等于<code>0</code>，这取决于输入的第一个数。接着需要分析<code>func4</code>执行的操作，其对应代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">0000000000400fce &lt;func4&gt;:</div><div class="line">  400fce: 48 83 ec 08           sub    $0x8,%rsp</div><div class="line">  400fd2: 89 d0                 mov    %edx,%eax</div><div class="line">  400fd4: 29 f0                 sub    %esi,%eax</div><div class="line">  400fd6: 89 c1                 mov    %eax,%ecx</div><div class="line">  400fd8: c1 e9 1f              shr    $0x1f,%ecx</div><div class="line">  400fdb: 01 c8                 add    %ecx,%eax</div><div class="line">  400fdd: d1 f8                 sar    %eax</div><div class="line">  400fdf: 8d 0c 30              lea    (%rax,%rsi,1),%ecx</div><div class="line">  400fe2: 39 f9                 cmp    %edi,%ecx</div><div class="line">  400fe4: 7e 0c                 jle    400ff2 &lt;func4+0x24&gt;</div><div class="line">  400fe6: 8d 51 ff              lea    -0x1(%rcx),%edx</div><div class="line">  400fe9: e8 e0 ff ff ff        callq  400fce &lt;func4&gt;</div><div class="line">  400fee: 01 c0                 add    %eax,%eax</div><div class="line">  400ff0: eb 15                 jmp    401007 &lt;func4+0x39&gt;</div><div class="line">  400ff2: b8 00 00 00 00        mov    $0x0,%eax</div><div class="line">  400ff7: 39 f9                 cmp    %edi,%ecx</div><div class="line">  400ff9: 7d 0c                 jge    401007 &lt;func4+0x39&gt;</div><div class="line">  400ffb: 8d 71 01              lea    0x1(%rcx),%esi</div><div class="line">  400ffe: e8 cb ff ff ff        callq  400fce &lt;func4&gt;</div><div class="line">  401003: 8d 44 00 01           lea    0x1(%rax,%rax,1),%eax</div><div class="line">  401007: 48 83 c4 08           add    $0x8,%rsp</div><div class="line">  40100b: c3                    retq</div></pre></td></tr></table></figure>
<p>在分析<code>func4</code>之前，不要忘了传递到<code>func4</code>的三个参数分别存储于寄存器<code>%edi</code>、<code>%esi</code>和<code>%edx</code>，其值分别为<code>x</code>(输入的第一个数)、<code>0</code>和<code>14</code>。在<code>0x400fe9</code>处执行了指令<code>callq 400fce &lt;func4&gt;</code>，因此<code>func4</code>很可能是个递归函数，我们将<code>func4</code>翻译成等价的<code>C</code>代码，如下所示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">func4</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> z)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> t = z - y;</div><div class="line">    <span class="keyword">int</span> k = t &gt;&gt; <span class="number">31</span>;</div><div class="line">    t = (t + k) &gt;&gt; <span class="number">1</span>;</div><div class="line">    k = t + y;</div><div class="line">    <span class="keyword">if</span>(k &lt;= x) &#123;</div><div class="line">        t = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span>(k &gt;= x) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            y = k + <span class="number">1</span>;</div><div class="line">            func4(x, y, z);</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        z = k - <span class="number">1</span>;</div><div class="line">        func4(x, y, z);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>func4</code>的目的是要让函数退出后<code>%eax</code>的值为<code>0</code>，而在<code>0x400ff2</code>处<code>mov $0x0,%eax</code>显示的将<code>%eax</code>的值设置为<code>0</code>，该指令对应于<code>C</code>代码中的<code>t = 0</code>。并且，<code>func4</code>执行递归的退出条件为<code>k == x</code>，其中<code>x</code>对应于输入的第一个数，而<code>k</code>则可以通过一系列计算得到，由于<code>y = 0</code>且<code>z = 14</code>，易知<code>k = 7</code>，因此输入的第一个数即为<code>7</code>。将字符串<code>7 0</code>作为<code>phase_4</code>的输入，拆弹成功，如下图所示。</p>
<p><img src="/img/2017-04-26-Image 7.png" alt=""></p>
<h2 id="Phase-5"><a href="#Phase-5" class="headerlink" title="Phase 5"></a>Phase 5</h2><p><code>phase_5</code>对应的代码如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">0000000000401062 &lt;phase_5&gt;:</div><div class="line">  401062: 53                    push   %rbx</div><div class="line">  401063: 48 83 ec 20           sub    $0x20,%rsp</div><div class="line">  401067: 48 89 fb              mov    %rdi,%rbx</div><div class="line">  40106a: 64 48 8b 04 25 28 00  mov    %fs:0x28,%rax</div><div class="line">  401071: 00 00 </div><div class="line">  401073: 48 89 44 24 18        mov    %rax,0x18(%rsp)</div><div class="line">  401078: 31 c0                 xor    %eax,%eax</div><div class="line">  40107a: e8 9c 02 00 00        callq  40131b &lt;string_length&gt;</div><div class="line">  40107f: 83 f8 06              cmp    $0x6,%eax</div><div class="line">  401082: 74 4e                 je     4010d2 &lt;phase_5+0x70&gt;</div><div class="line">  401084: e8 b1 03 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  401089: eb 47                 jmp    4010d2 &lt;phase_5+0x70&gt;</div><div class="line">  40108b: 0f b6 0c 03           movzbl (%rbx,%rax,1),%ecx</div><div class="line">  40108f: 88 0c 24              mov    %cl,(%rsp)</div><div class="line">  401092: 48 8b 14 24           mov    (%rsp),%rdx</div><div class="line">  401096: 83 e2 0f              and    $0xf,%edx</div><div class="line">  401099: 0f b6 92 b0 24 40 00  movzbl 0x4024b0(%rdx),%edx</div><div class="line">  4010a0: 88 54 04 10           mov    %dl,0x10(%rsp,%rax,1)</div><div class="line">  4010a4: 48 83 c0 01           add    $0x1,%rax</div><div class="line">  4010a8: 48 83 f8 06           cmp    $0x6,%rax</div><div class="line">  4010ac: 75 dd                 jne    40108b &lt;phase_5+0x29&gt;</div><div class="line">  4010ae: c6 44 24 16 00        movb   $0x0,0x16(%rsp)</div><div class="line">  4010b3: be 5e 24 40 00        mov    $0x40245e,%esi</div><div class="line">  4010b8: 48 8d 7c 24 10        lea    0x10(%rsp),%rdi</div><div class="line">  4010bd: e8 76 02 00 00        callq  401338 &lt;strings_not_equal&gt;</div><div class="line">  4010c2: 85 c0                 test   %eax,%eax</div><div class="line">  4010c4: 74 13                 je     4010d9 &lt;phase_5+0x77&gt;</div><div class="line">  4010c6: e8 6f 03 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  4010cb: 0f 1f 44 00 00        nopl   0x0(%rax,%rax,1)</div><div class="line">  4010d0: eb 07                 jmp    4010d9 &lt;phase_5+0x77&gt;</div><div class="line">  4010d2: b8 00 00 00 00        mov    $0x0,%eax</div><div class="line">  4010d7: eb b2                 jmp    40108b &lt;phase_5+0x29&gt;</div><div class="line">  4010d9: 48 8b 44 24 18        mov    0x18(%rsp),%rax</div><div class="line">  4010de: 64 48 33 04 25 28 00  xor    %fs:0x28,%rax</div><div class="line">  4010e5: 00 00 </div><div class="line">  4010e7: 74 05                 je     4010ee &lt;phase_5+0x8c&gt;</div><div class="line">  4010e9: e8 42 fa ff ff        callq  400b30 &lt;__stack_chk_fail@plt&gt;</div><div class="line">  4010ee: 48 83 c4 20           add    $0x20,%rsp</div><div class="line">  4010f2: 5b                    pop    %rbx</div><div class="line">  4010f3: c3                    retq</div></pre></td></tr></table></figure>
<p>根据<code>x86-64</code>寄存器使用规范，<code>%rdi</code>寄存器存储的是第一个参数的值，由于输入的是字符串，因此<code>%rdi</code>存储的应该是输入字符串的起始地址。<code>0x401067</code>处的指令<code>mov %rdi,%rbx</code>将字符串起始地址保存在<code>%rbx</code>中，即<code>%rbx</code>为基址寄存器。指令<code>xor %eax,%eax</code>的作用是将<code>%eax</code>清零，接着调用<code>string_length</code>函数获取输入字符串的长度，并将长度值（返回值）存储于<code>%eax</code>。指令<code>cmp $0x6,%eax</code>将<code>string_length</code>的返回值与常数<code>6</code>作比较，若不相等则会引爆炸弹，由此可以得知，<code>phase_5</code>的输入字符串长度应该等于<code>6</code>。</p>
<p>当输入字符串的长度等于<code>6</code>，<code>phase_5</code>跳转至<code>0x4010d2</code>处执行指令<code>mov $0x0,%eax</code>，接着又跳转至<code>0x40108b</code>处执行指令<code>movzbl (%rbx,%rax,1),%ecx</code>，可以发现<code>0x40108b</code>至<code>0x4010ac</code>构成了一个循环，且在循环退出后在<code>0x4010bd</code>处调动了<code>strings_not_equal</code>来比较字符串是否相等，若相等，则拆弹成功。其中，由<code>mov $0x40245e,%esi</code>指令可知，待比较的字符串存储于地址<code>0x40245e</code>处，打印以该地址作为起始地址的字符串，如下图所示。</p>
<p><img src="/img/2017-04-26-Image 8.png" alt=""></p>
<p>待比较的字符串为<code>flyers</code>，且长度也为<code>6</code>。所以，接下来的关键任务是需要对循环操作进行分析，理解该循环操作对输入字符串做了哪些操作。提取循环操作的代码，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">40108b: 0f b6 0c 03           movzbl (%rbx,%rax,1),%ecx</div><div class="line">40108f: 88 0c 24              mov    %cl,(%rsp)</div><div class="line">401092: 48 8b 14 24           mov    (%rsp),%rdx</div><div class="line">401096: 83 e2 0f              and    $0xf,%edx</div><div class="line">401099: 0f b6 92 b0 24 40 00  movzbl 0x4024b0(%rdx),%edx</div><div class="line">4010a0: 88 54 04 10           mov    %dl,0x10(%rsp,%rax,1)</div><div class="line">4010a4: 48 83 c0 01           add    $0x1,%rax</div><div class="line">4010a8: 48 83 f8 06           cmp    $0x6,%rax</div><div class="line">4010ac: 75 dd                 jne    40108b &lt;phase_5+0x29&gt;</div></pre></td></tr></table></figure>
<p>由于<code>%rbx</code>存储的是输入字符串的起始地址，<code>%rax</code>初始化为<code>0</code>，其作用等价于下标，因此<code>movzbl (%rbx,%rax,1),%ecx</code>指令的作用是将字符串的第<code>%rax</code>个字符存储于<code>%ecx</code>，<code>movzbl</code>意味做了零扩展。接着，<code>mov  %cl,(%rsp)</code>指令取<code>%ecx</code>的低<code>8</code>位，即一个字符的大小，通过内存间接存储至<code>%rdx</code>中。<code>and  $0xf,%edx</code>指令将<code>%edx</code>的值与常数<code>0xf</code>进行位与，由指令<code>movzbl 0x4024b0(%rdx),%edx</code>可知，位与后的值将会作为偏移量，以<code>0x4024b0</code>为基址，将偏移后的值存储至<code>%edx</code>。最后，指令<code>mov %dl,0x10(%rsp,%rax,1)</code>以<code>%edx</code>低<code>8</code>位的值作为新的字符，对原有字符进行替换。</p>
<p>综上，<code>phase_5</code>遍历输入字符串的每个字符，将字符的低<code>4</code>位作为偏移量，以<code>0x4024b0</code>为起始地址，将新地址对应的字符替换原有字符，最终得到<code>flyers</code>字符串。打印<code>0x4024b0</code>处的内容，如下图所示。</p>
<p><img src="/img/2017-04-26-Image 9.png" alt=""></p>
<p>例如，如果要得到字符<code>f</code>，那么偏移量应为<code>9</code>，二进制表示为<code>1001</code>，通过查找<code>ASCII</code>表，可知字符<code>i</code>的<code>ASCII</code>编码为<code>01101001</code>，满足要求。剩余<code>5</code>个字符采用同样的策略可以依次求得，最终，<code>phase_5</code>的输入字符串为<code>ionefg</code>。</p>
<h2 id="Phase-6"><a href="#Phase-6" class="headerlink" title="Phase 6"></a>Phase 6</h2><p><code>phase_6</code>对应的代码非常长，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line">00000000004010f4 &lt;phase_6&gt;:</div><div class="line">  4010f4: 41 56                 push   %r14</div><div class="line">  4010f6: 41 55                 push   %r13</div><div class="line">  4010f8: 41 54                 push   %r12</div><div class="line">  4010fa: 55                    push   %rbp</div><div class="line">  4010fb: 53                    push   %rbx</div><div class="line">  4010fc: 48 83 ec 50           sub    $0x50,%rsp</div><div class="line">  401100: 49 89 e5              mov    %rsp,%r13</div><div class="line">  401103: 48 89 e6              mov    %rsp,%rsi</div><div class="line">  401106: e8 51 03 00 00        callq  40145c &lt;read_six_numbers&gt;</div><div class="line">  40110b: 49 89 e6              mov    %rsp,%r14               # %r14存储数组起始地址</div><div class="line">  40110e: 41 bc 00 00 00 00     mov    $0x0,%r12d              # 将%r12d初始化为0</div><div class="line">  </div><div class="line">  #################### Section 1:确认数组中所有的元素小于等于6且不存在重复值 ###################</div><div class="line">  401114: 4c 89 ed              mov    %r13,%rbp               # %r13和%rbp存储数组某个元素的地址，并不是第1个元素，意识到这点需要结合0x40114d处的指令</div><div class="line">  401117: 41 8b 45 00           mov    0x0(%r13),%eax          # %eax存储第%r13个数</div><div class="line">  40111b: 83 e8 01              sub    $0x1,%eax               # 将%eax的值减1</div><div class="line">  40111e: 83 f8 05              cmp    $0x5,%eax               # 将%eax的值与常数5做比较</div><div class="line">  401121: 76 05                 jbe    401128 &lt;phase_6+0x34&gt;</div><div class="line">  401123: e8 12 03 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  401128: 41 83 c4 01           add    $0x1,%r12d              # 如果%eax的值小于等于5，%r12d加1</div><div class="line">  40112c: 41 83 fc 06           cmp    $0x6,%r12d              # 将%r12d与常数6做比较</div><div class="line">  401130: 74 21                 je     401153 &lt;phase_6+0x5f&gt;</div><div class="line">  401132: 44 89 e3              mov    %r12d,%ebx              # %ebx起了数组下标的作用</div><div class="line">  </div><div class="line">  # 用于判断数组6个数是否存在重复值，若存在，引爆炸弹</div><div class="line">  401135: 48 63 c3              movslq %ebx,%rax               # 将数组下标存储至%rax</div><div class="line">  401138: 8b 04 84              mov    (%rsp,%rax,4),%eax      # 将下一个数存储至%eax</div><div class="line">  40113b: 39 45 00              cmp    %eax,0x0(%rbp)          # 将第1个数与%eax的值(当前数)做比较</div><div class="line">  40113e: 75 05                 jne    401145 &lt;phase_6+0x51&gt;   # 若相等，引爆炸弹   </div><div class="line">  401140: e8 f5 02 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  401145: 83 c3 01              add    $0x1,%ebx               # 数组下标加1            </div><div class="line">  401148: 83 fb 05              cmp    $0x5,%ebx               # 判断数组下标是否越界(&lt;=5)</div><div class="line">  40114b: 7e e8                 jle    401135 &lt;phase_6+0x41&gt;</div><div class="line">  </div><div class="line">  40114d: 49 83 c5 04           add    $0x4,%r13               # %r13存储数组下一个数的地址</div><div class="line">  401151: eb c1                 jmp    401114 &lt;phase_6+0x20&gt;</div><div class="line">  ####################################### Section 1 end ######################################</div><div class="line">  </div><div class="line">  ################ Section 2：用7减去数组的每个元素，并将相减后的元素替换原有元素 #################</div><div class="line">  401153: 48 8d 74 24 18        lea    0x18(%rsp),%rsi         # 0x18(%rsp)是数组的边界地址：0x18 = 24         </div><div class="line">  401158: 4c 89 f0              mov    %r14,%rax               # 将数组起始地址存储于%rax</div><div class="line">  40115b: b9 07 00 00 00        mov    $0x7,%ecx</div><div class="line">  </div><div class="line">  401160: 89 ca                 mov    %ecx,%edx               # %edx = 7</div><div class="line">  401162: 2b 10                 sub    (%rax),%edx             # %edx = 7 - 数组元素</div><div class="line">  401164: 89 10                 mov    %edx,(%rax)             # 用相减后的元素(%edx)替换原有元素</div><div class="line">  401166: 48 83 c0 04           add    $0x4,%rax               # %rax存储数组下一个元素的地址</div><div class="line">  40116a: 48 39 f0              cmp    %rsi,%rax               # 判断是否越界</div><div class="line">  40116d: 75 f1                 jne    401160 &lt;phase_6+0x6c&gt;</div><div class="line">  ####################################### Section 2 end ######################################</div><div class="line">  </div><div class="line">  ########################## Section 3：根据输入数组重排结构体数组 ##############################</div><div class="line">  40116f: be 00 00 00 00        mov    $0x0,%esi               # 将%esi初始化为0，作为数组下标</div><div class="line">  401174: eb 21                 jmp    401197 &lt;phase_6+0xa3&gt;</div><div class="line">  </div><div class="line">  401176: 48 8b 52 08           mov    0x8(%rdx),%rdx          # 0x8(%rdx)为下一个元素的地址</div><div class="line">  40117a: 83 c0 01              add    $0x1,%eax               </div><div class="line">  40117d: 39 c8                 cmp    %ecx,%eax               # %ecx存储了数组当前值(第%esi个元素)</div><div class="line">  40117f: 75 f5                 jne    401176 &lt;phase_6+0x82&gt;</div><div class="line">  </div><div class="line">  401181: eb 05                 jmp    401188 &lt;phase_6+0x94&gt;</div><div class="line">  401183: ba d0 32 60 00        mov    $0x6032d0,%edx          # %edx存储结构体数组第1个元素的地址</div><div class="line">  401188: 48 89 54 74 20        mov    %rdx,0x20(%rsp,%rsi,2)  # %rsi的初始值为0；该指令的作用是将结构体数组的第%ecx个元素的地址存储在内存的某个位置(以%rsp + 0x20为基地址，%rsi为偏移量)</div><div class="line">  40118d: 48 83 c6 04           add    $0x4,%rsi               # 增加偏移量</div><div class="line">  401191: 48 83 fe 18           cmp    $0x18,%rsi</div><div class="line">  401195: 74 14                 je     4011ab &lt;phase_6+0xb7&gt;</div><div class="line">  401197: 8b 0c 34              mov    (%rsp,%rsi,1),%ecx      # %ecx存储数组第%esi个元素</div><div class="line">  40119a: 83 f9 01              cmp    $0x1,%ecx               # 将数组第%esi个元素与常数1做比较</div><div class="line">  40119d: 7e e4                 jle    401183 &lt;phase_6+0x8f&gt;   # 实际上不会小于1，如果数组的第1个元素等于1，那么跳转至0x401183处</div><div class="line">  40119f: b8 01 00 00 00        mov    $0x1,%eax</div><div class="line">  4011a4: ba d0 32 60 00        mov    $0x6032d0,%edx          # %edx存储结构体数组第1个元素的地址</div><div class="line">  4011a9: eb cb                 jmp    401176 &lt;phase_6+0x82&gt;</div><div class="line">  ####################################### Section 3 end ######################################</div><div class="line">  </div><div class="line">  ######################### Section 4：修改结构体数组元素的next域值 #############################</div><div class="line">  4011ab: 48 8b 5c 24 20        mov    0x20(%rsp),%rbx         # %rbx存储地址数组的第1个元素的值</div><div class="line">  4011b0: 48 8d 44 24 28        lea    0x28(%rsp),%rax         # %rax存储地址数组的第2个元素的地址</div><div class="line">  4011b5: 48 8d 74 24 50        lea    0x50(%rsp),%rsi</div><div class="line">  4011ba: 48 89 d9              mov    %rbx,%rcx               # %rcx存储地址数组的第1个元素的值</div><div class="line">  </div><div class="line">  # 下面用i和i+1来表示元素位置</div><div class="line">  4011bd: 48 8b 10              mov    (%rax),%rdx             # %rdx存储地址数组的第i+1个元素的值</div><div class="line">  4011c0: 48 89 51 08           mov    %rdx,0x8(%rcx)          # 把第i+1和元素的值存储于第i个结构体元素的next域中，next域的地址为0x8(%rcx)的值</div><div class="line">  4011c4: 48 83 c0 08           add    $0x8,%rax</div><div class="line">  4011c8: 48 39 f0              cmp    %rsi,%rax</div><div class="line">  4011cb: 74 05                 je     4011d2 &lt;phase_6+0xde&gt;</div><div class="line">  4011cd: 48 89 d1              mov    %rdx,%rcx</div><div class="line">  4011d0: eb eb                 jmp    4011bd &lt;phase_6+0xc9&gt;</div><div class="line">  ####################################### Section 4 end ######################################</div><div class="line">  </div><div class="line">  ######################### Section 5：判断结构体数组是否是递减序列 #############################</div><div class="line">  4011d2: 48 c7 42 08 00 00 00  movq   $0x0,0x8(%rdx)</div><div class="line">  4011d9: 00 </div><div class="line">  4011da: bd 05 00 00 00        mov    $0x5,%ebp</div><div class="line">  4011df: 48 8b 43 08           mov    0x8(%rbx),%rax</div><div class="line">  4011e3: 8b 00                 mov    (%rax),%eax</div><div class="line">  4011e5: 39 03                 cmp    %eax,(%rbx)</div><div class="line">  4011e7: 7d 05                 jge    4011ee &lt;phase_6+0xfa&gt;</div><div class="line">  4011e9: e8 4c 02 00 00        callq  40143a &lt;explode_bomb&gt;</div><div class="line">  4011ee: 48 8b 5b 08           mov    0x8(%rbx),%rbx</div><div class="line">  4011f2: 83 ed 01              sub    $0x1,%ebp</div><div class="line">  4011f5: 75 e8                 jne    4011df &lt;phase_6+0xeb&gt;</div><div class="line">  ####################################### Section 5 end ######################################</div><div class="line">  </div><div class="line">  4011f7: 48 83 c4 50           add    $0x50,%rsp</div><div class="line">  4011fb: 5b                    pop    %rbx</div><div class="line">  4011fc: 5d                    pop    %rbp</div><div class="line">  4011fd: 41 5c                 pop    %r12</div><div class="line">  4011ff: 41 5d                 pop    %r13</div><div class="line">  401201: 41 5e                 pop    %r14</div><div class="line">  401203: c3                    retq</div></pre></td></tr></table></figure>
<p>分析清楚<code>phase_6</code>非常需要耐心，我将<code>phase_6</code>划分为<code>5</code>个<code>Section</code>，每个<code>Section</code>完成特定的功能，详细的注释直接附到了相关代码。前两个<code>Section</code>不难理解：<code>Section 1</code>确保输入数组的值的范围在<code>1 ~ 6</code>且不存在重复值；<code>Section 2</code>用<code>7</code>减去输入数组的每个元素，相当于求补。<code>Section 3</code>中出现了一个常数地址，使用<code>gdb</code>将该地址存储的内容打印出来，如下图所示。</p>
<p><img src="/img/2017-04-26-Image 11.png" alt=""></p>
<p>可以意识到这其实是一个链表数据结构，链表的节点由<code>3</code>部分组成：<code>value 1</code>、<code>value 2</code>和一个地址值(<code>next</code>域，指向下一个节点)。<code>Section 3</code>根据我们输入的数组，按照数组元素的值将对应结构体数组中的元素的首地址存储到内存的某个位置(<code>mov %rdx,0x20(%rsp,%rsi,2)</code>)。例如，假设输入数组为<code>[3, 4, 5, 6, 1, 2]</code>，那么<code>Section 3</code>首先会将结构体数组的第<code>3</code>个元素的地址存储到<code>0x20(%rsp,%rsi,2)</code>处，接着将结构体数组的第<code>4</code>个元素……依次类推。</p>
<p><code>Section 4</code>根据<code>Section 3</code>构建的地址数组，修改结构体数组的<code>next</code>域的值，实现单链表的排序操作。<code>Section 5</code>进行验证，要求单链表递减排序，若满足要求，那么拆弹成功。</p>
<p>综上，根据已有的结构体数组以及<code>phase_6</code>的操作，若要实现单链表的递减排序，应将第<code>3</code>个节点放在第<code>1</code>位，将第<code>4</code>个节点放在第<code>2</code>位……最终得到序列：<code>[3, 4, 5, 6, 1, 2]</code>。不要忘记<code>Section 2</code>中的求补操作，所以<code>phase_6</code>的输入序列应该为<code>[4, 3, 2, 1, 6, 5]</code>。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>至此，<code>Bomb Lab</code>包含了<code>6</code>个<code>phase</code>全部拆弹成功。将输入序列存储在文件，然后将文件作为<code>bomb</code>二进制文件的参数，运行结果如下图所示。</p>
<p><img src="/img/2017-04-26-Image 10.png" alt=""></p>
</div><div class="tags"><a href="/tags/CSAPP/">CSAPP</a><a href="/tags/Assembly/">Assembly</a></div><div class="post-nav"><a href="/2017/04/04/理解Golang中的defer/" class="pre">理解Golang中的defer</a><a href="/2017/05/03/6-824-Lab-1-MapReduce/" class="next">6.824 Lab 1: MapReduce</a></div><div id="disqus_thread"><script>var disqus_shortname = 'tinylcy';
var disqus_identifier = '2017/04/26/CSAPP-Bomb-Lab/';
var disqus_title = 'CSAPP: Bomb Lab';
var disqus_url = 'http://tinylcy.me/2017/04/26/CSAPP-Bomb-Lab/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//tinylcy.disqus.com/count.js" async></script></div><div class="post-reward"><div id="reward_board" class="reward_bar center"><a id="btn_reward" href="javascript:;" title="打赏" class="btn_reward"></a><div class="reward_txt">好心的朋友，我是在做买卖 :)<br></div></div><div id="reward_guide" class="reward_bar center hidden"><img src="/img/wechat.png" title="微信打赏"></div><script type="text/javascript">document.getElementById('btn_reward').onclick = function(){
    $('#reward_board').addClass('hidden');
    $('#reward_guide').removeClass('hidden');
}</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://tinylcy.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Unix-Linux/" style="font-size: 15px;">Unix/Linux</a> <a href="/tags/DistributedSystems/" style="font-size: 15px;">DistributedSystems</a> <a href="/tags/Life/" style="font-size: 15px;">Life</a> <a href="/tags/CSAPP/" style="font-size: 15px;">CSAPP</a> <a href="/tags/Assembly/" style="font-size: 15px;">Assembly</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/6-824/" style="font-size: 15px;">6.824</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/TCP-IP/" style="font-size: 15px;">TCP/IP</a> <a href="/tags/Webx/" style="font-size: 15px;">Webx</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/C/" style="font-size: 15px;">C</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://wdxtub.com/" title="wdxtub" target="_blank">wdxtub</a><ul></ul><a href="http://brianway.github.io/" title="brianway" target="_blank">brianway</a><ul></ul><a href="http://www.yinwang.org" title="yinwang" target="_blank">yinwang</a><ul></ul><a href="http://coolshell.cn/" title="coolshell" target="_blank">coolshell</a><ul></ul><a href="http://lucida.me/" title="lucida" target="_blank">lucida</a><ul></ul><a href="http://mindhacks.cn/" title="mindhacks" target="_blank">mindhacks</a><ul></ul><a href="http://mindwind.me/" title="mindwind" target="_blank">mindwind</a><ul></ul><a href="http://lifeofzjs.com/" title="lifeofzjs" target="_blank">lifeofzjs</a><ul></ul><a href="http://papwin.com/" title="潘岸平的獨立博客" target="_blank">潘岸平的獨立博客</a><ul></ul><a href="http://www.zreading.cn/" title="左岸读书" target="_blank">左岸读书</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a>2017 </a><a href="/." rel="nofollow">tinylcy.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>