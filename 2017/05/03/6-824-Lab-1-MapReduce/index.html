<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>6.824 Lab 1: MapReduce | tinylcy</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">6.824 Lab 1: MapReduce</h1><a id="logo" href="/.">tinylcy</a><p class="description">辰洋的博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/timeline/"><i class="fa fa-envira"> 时间线</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="https://github.com/tinylcy"><i class="fa fa-github"> GitHub</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><link rel="stylesheet" type="text/css" href="/css/reward.css"></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">6.824 Lab 1: MapReduce</h1><div class="post-meta">May 3, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/05/03/6-824-Lab-1-MapReduce/" href="/2017/05/03/6-824-Lab-1-MapReduce/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MapReduce"><span class="toc-number">1.</span> <span class="toc-text">MapReduce</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Execution-Overview"><span class="toc-number">1.1.</span> <span class="toc-text">Execution Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Master-Data-Structures"><span class="toc-number">1.2.</span> <span class="toc-text">Master Data Structures</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fault-Tolerance"><span class="toc-number">1.3.</span> <span class="toc-text">Fault Tolerance</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Worker-Failure"><span class="toc-number">1.3.1.</span> <span class="toc-text">Worker Failure</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Master-Failure"><span class="toc-number">1.3.2.</span> <span class="toc-text">Master Failure</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lab"><span class="toc-number">2.</span> <span class="toc-text">Lab</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-1-Map-Reduce-input-and-output"><span class="toc-number">2.1.</span> <span class="toc-text">Part 1: Map/Reduce input and output</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-2-Single-worker-word-count"><span class="toc-number">2.2.</span> <span class="toc-text">Part 2: Single-worker word count</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-3-Distributing-MapReduce-tasks"><span class="toc-number">2.3.</span> <span class="toc-text">Part 3: Distributing MapReduce tasks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Part-4-Handling-worker-failures"><span class="toc-number">2.4.</span> <span class="toc-text">Part 4: Handling worker failures</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">3.</span> <span class="toc-text">Implementation</span></a></li></ol></div></div><div class="post-content"><p>开始学习大名鼎鼎的<a href="http://nil.csail.mit.edu/6.824/2016/index.html" target="_blank" rel="external">MIT 6.824: Distributed Systems</a>课程，我跟的是<code>2016</code>年的课程，课程的主要内容是读<code>Paper</code>和做<code>Lab</code>，使用的语言为<code>Go</code>。五一假期期间我基本做完了<a href="http://nil.csail.mit.edu/6.824/2016/labs/lab-1.html" target="_blank" rel="external">Lab 1</a>，感觉难度还是相当大的。本篇文章是我对<code>Lab 1</code>的一个总结。</p>
<a id="more"></a>
<h2 id="MapReduce"><a href="#MapReduce" class="headerlink" title="MapReduce"></a>MapReduce</h2><p>每次读<a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/mapreduce-osdi04.pdf" target="_blank" rel="external">MapReduce</a>论文，都会有新的收获，也自知还有理解不到位的地方。</p>
<h3 id="Execution-Overview"><a href="#Execution-Overview" class="headerlink" title="Execution Overview"></a>Execution Overview</h3><ul>
<li>输入数据被划分为<code>M</code>个分片，由<code>map worker</code>产生的中间<code>key-value pairs</code>被划分为<code>R</code>个分片。其中<code>M</code>的大小取决于<code>GFS</code>块的大小，<code>R</code>取决于<code>reduce worker</code>的个数。所以，整个<code>MapReduce Job</code>包括<code>M</code>个<code>map task</code>和<code>R</code>个<code>reduce task</code>。</li>
<li>在<code>map</code>阶段，<code>map worker</code>把输出的中间<code>key-value pairs</code>分割成<code>R</code>个<code>region</code>，注意<code>pairs</code>首先会存储在缓冲区中，然后定期的写入本地磁盘。<code>pairs</code>在<code>map worker</code>上的位置信息会发送给<code>master</code>，由<code>master</code>通知<code>reduce worker</code>数据读取位置信息。</li>
<li>在<code>reduce</code>阶段，当<code>reduce worker</code>获取了输入数据的位置信息后，通过<code>RPC</code>读取数据。当<code>reduce worker</code>获取了所有的相关数据之后，会对它们进行一次排序，排序的目的在于不同<code>key</code>的<code>pairs</code>会汇聚到同一个<code>reduce worker</code>。</li>
<li>当所有的<code>task</code>完成后，一共会产生<code>R</code>个输出文件，每个<code>reduce worker</code>对应一个。一般来说没有必要将这<code>R</code>个文件合并成一个文件，因为这<code>R</code>个文件往往会作为下一个<code>MapReduce Job</code>的输入数据。</li>
</ul>
<h3 id="Master-Data-Structures"><a href="#Master-Data-Structures" class="headerlink" title="Master Data Structures"></a>Master Data Structures</h3><ul>
<li><code>master</code>会记录所有<code>map task</code>和<code>reduce task</code>的状态(<code>idle</code>，<code>in-progress</code>和<code>completed</code>)信息。同时，<code>master</code>还会保存那些处于<code>non-idle</code>状态的<code>task</code>所关联的<code>worker</code>的信息。</li>
<li>对于每个状态为<code>completed</code>的<code>map task</code>，<code>master</code>会保存该<code>map task</code>对应的<code>R</code>个<code>region</code>的位置信息和大小信息。</li>
</ul>
<h3 id="Fault-Tolerance"><a href="#Fault-Tolerance" class="headerlink" title="Fault Tolerance"></a>Fault Tolerance</h3><h4 id="Worker-Failure"><a href="#Worker-Failure" class="headerlink" title="Worker Failure"></a>Worker Failure</h4><ul>
<li><code>master</code>通过周期性的<code>ping</code>所有的<code>worker</code>来确认<code>worker</code>是否可用，如果某个<code>worker</code>崩溃了，那么在该<code>worker</code>上完成的所有<code>map task</code>都会回退到<code>idle</code>状态，因此这些<code>task</code>会被重新调度到可用的<code>worker</code>上。同理，如果处于<code>in-progress</code>的<code>map task</code>或<code>reduce task</code>所在的<code>worker</code>崩溃了，那么这些<code>task</code>也会被重新调度到可用的<code>worker</code>上重新执行。</li>
<li>如果某个<code>worker</code>崩溃了，其上处于<code>completed</code>状态的<code>map task</code>需要重新被调度执行，这是因为<code>map task</code>的输出数据是存储于<code>local disk</code>。相反，如果某个<code>worker</code>崩溃了，其上处于<code>completed</code>状态的<code>reduce task</code>不需要重新被调度执行，因为<code>reduce task</code>的输出数据是存储在<code>global file system</code>上的。</li>
<li>当<code>reduce worker</code>在执行<code>reduce task</code>时，如果某个<code>map task</code>对应的<code>worker</code>由<code>worker A</code>切换到了<code>worker B</code>(可能是因为<code>worker A</code>崩溃了)，那么<code>master</code>会通知该<code>reduce worker</code>从<code>worker B</code>读取数据。</li>
</ul>
<h4 id="Master-Failure"><a href="#Master-Failure" class="headerlink" title="Master Failure"></a>Master Failure</h4><ul>
<li><code>master</code>通过定期的做<code>checkpoints</code>来保证<code>master</code>的容错性。</li>
<li>由于<code>master</code>只有一个，所以可以认为<code>master</code>出故障的概率很小。如果真的出故障了，那么根据需要重新执行<code>MapReduce Job</code>。</li>
</ul>
<h2 id="Lab"><a href="#Lab" class="headerlink" title="Lab"></a>Lab</h2><p><code>Lab 1</code>包括<code>4</code>个<code>Part</code>，<code>Part 1 &amp; Part 2</code>实现<code>Sequential MapReduce</code>，<code>Part 3 &amp; Part 4</code>实现<code>Distributed MapReduce</code>，并且要解决<code>worker failure</code>。同时，<code>Lab 1</code>提供了<code>MapReduce</code>的整个框架，并实现了与核心内容无关的代码。在完成各个<code>Part</code>之前，我们需要理解<code>Lab 1</code>实现的两个版本的<code>MapReduce</code>框架的设计思路。</p>
<ul>
<li><code>master</code>和<code>worker</code>以<code>goroutine</code>的形式存在，当<code>worker</code>可用时，以<code>RPC</code>的方式向<code>master</code>注册，<code>master</code>通过调用<code>schedule()</code>来实现<code>task</code>的调度。同时，在<code>Distributed MapReduce</code>中<code>schedule()</code>还需要处理<code>worker failure</code>。<code>schedule()</code>将会以参数的形式存在于<code>Sequential/Distributed MapReduce</code>。</li>
<li>论文中<code>map task</code>以块作为分割，而<code>Lab</code>中的<code>map task</code>将以文件作为分割。</li>
<li>在<code>map</code>阶段，对于每个<code>map task</code>(一个输入文件)，<code>master</code>会至少调用一次<code>doMap()</code>。同理在<code>reduce</code>阶段，<code>master</code>对每个<code>reduce task</code>至少调用一次<code>doReduce()</code>。在<code>Sequential MapReduce</code>中，<code>Sequential()</code>[<code>master.go</code>]的核心参数<code>schedule()</code>遍历了<code>file slice</code>，根据当前所处的<code>phase</code>对每个<code>task</code>调用<code>doMap()</code>或<code>doReduce()</code>。在<code>Distributed MapReduce</code>中，<code>Distributed()</code>[<code>master.go</code>]的核心参数<code>schedule()</code>需要我们去实现(<code>Part 3 &amp; Part 4</code>)。</li>
<li>在完成了所有的<code>map task</code>和<code>reduce task</code>之后，<code>master</code>会调用<code>merge()</code>对<code>reduce worker</code>的输出文件进行合并。</li>
<li>最后<code>master</code>向每个<code>worker</code>发送<code>Shutdown RPC</code>，然后关闭整个应用。</li>
</ul>
<p>理解完整个<code>Lab</code>的框架，下面谈谈每个<code>Part</code>需要注意的地方。</p>
<h3 id="Part-1-Map-Reduce-input-and-output"><a href="#Part-1-Map-Reduce-input-and-output" class="headerlink" title="Part 1: Map/Reduce input and output"></a>Part 1: Map/Reduce input and output</h3><p><code>Part 1</code>主要的内容是完成<code>doMap()</code>和<code>doReduce()</code>，在编码前一定要仔细阅读注释给我们提供的信息。</p>
<ul>
<li><code>doMap()</code>读取输入文件(<code>inFile</code>)的内容，通过<code>mapF</code>将其转化为<code>[]KeyValue</code>。对于每个<code>inFile</code>，<code>doMap</code>将产生<code>nReduce</code>(对应于论文中的<code>R</code>)个输出文件。同时，数据以<code>JSON</code>的格式存储至输出文件中。</li>
<li><code>doReduce()</code>从<code>nMap</code>(对应于论文中的<code>M</code>)个<code>map worker</code>读取输入数据(<code>[]KeyValue</code>)，注意输入数据的格式为<code>JSON</code>。根据<code>key</code>构建出<code>map[key]values</code>数据结构，对每个<code>key</code>(<code>string</code>)和对应的<code>values</code>(<code>[]string</code>)调用<code>reduceF()</code>。<code>doReduce()</code>产生一个输出文件。</li>
</ul>
<h3 id="Part-2-Single-worker-word-count"><a href="#Part-2-Single-worker-word-count" class="headerlink" title="Part 2: Single-worker word count"></a>Part 2: Single-worker word count</h3><p><code>Part 2</code>实现经典的<code>WordCount</code>，需要我们实现<code>mapF</code>和<code>reduceF</code>中的逻辑。需要注意的是要按照<code>Lab</code>提供的切词规范(<code>determined by unicode.IsLetter</code>)去分词，而不要想当然的用空格作为分隔符。</p>
<h3 id="Part-3-Distributing-MapReduce-tasks"><a href="#Part-3-Distributing-MapReduce-tasks" class="headerlink" title="Part 3: Distributing MapReduce tasks"></a>Part 3: Distributing MapReduce tasks</h3><p><code>Part 3</code>着手实现<code>Distributed MapReduce</code>，为了模拟真正的分布式环境，<code>master</code>和<code>worker</code>之间的通信和同步仅通过<code>RPC</code>和<code>channel</code>来实现。<code>Part 3</code>需要我们实现<code>schedule()</code>的调度逻辑。</p>
<ul>
<li><code>Distributed MapReduce</code>的实现逻辑在上文已有所提及，<code>Sequential MapReduce</code>顺序调度每个<code>task</code>执行，而在<code>Distributed MapReduce</code>中，<code>schedule()</code>将<code>task</code>调度到当前可用的<code>worker</code>上去执行。</li>
<li>只有当<code>map/reduce</code>阶段所有的<code>task</code>全部完成后，<code>schedule()</code>才能返回。这一点在代码中我是通过<code>sync.WaitGroup</code>来实现。</li>
<li>在分布式环境下，<code>schedule()</code>通过<code>RPC</code>调度<code>worker</code>执行<code>task</code>，同时输入文件的信息也是作为<code>RPC</code>参数传递。</li>
<li>当前可用的<code>worker</code>存储于<code>master</code>的<code>registerChannel</code>中。如果当前没有可用的<code>worker</code>，那么<code>schedule()</code>会进入阻塞状态，直至出现新的可用的<code>worker</code>。只有当存在可用的<code>worker</code>时才允许创建<code>goroutine</code>执行<code>task</code>(这一点体现在<code>schedule.go</code>的<code>line 38</code>和<code>line 42</code>)。</li>
</ul>
<h3 id="Part-4-Handling-worker-failures"><a href="#Part-4-Handling-worker-failures" class="headerlink" title="Part 4: Handling worker failures"></a>Part 4: Handling worker failures</h3><p><code>Part 4</code>需要解决<code>worker failure</code>，映射到具体的代码实现上，<code>work failure</code>是指在进行<code>RPC</code>时，<code>RPC</code>服务器返回了<code>call failed</code>信息。根据论文，我们只需要将<code>task</code>重新分配给另一个可用的<code>worker</code>，并将上次<code>RPC</code>失败的输入文件信息作为本次<code>RPC</code>的参数传递。</p>
<p>需要注意的是，<code>RPC</code>失败并不一定意味着<code>worker</code>崩溃了，也有可能是因为网络原因导致<code>worker</code>不可达，所以有可能导致多个<code>worker</code>在执行着相同的<code>task</code>。不过由于<code>task</code>的幂等性，这并没有什么问题，<code>master</code>记录着每个<code>task</code>对应的真正有效的<code>worker</code>。</p>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p><code>Lab 1</code>的代码实现在<a href="https://github.com/tinylcy/mit-6.824" target="_blank" rel="external">这里</a>。</p>
</div><div class="tags"><a href="/tags/DistributedSystems/">DistributedSystems</a><a href="/tags/6-824/">6.824</a></div><div class="post-nav"><a href="/2017/04/26/CSAPP-Bomb-Lab/" class="pre">CSAPP: Bomb Lab</a><a href="/2017/05/06/CSAPP-Attack-Lab/" class="next">CSAPP: Attack Lab</a></div><div id="disqus_thread"><script>var disqus_shortname = 'tinylcy';
var disqus_identifier = '2017/05/03/6-824-Lab-1-MapReduce/';
var disqus_title = '6.824 Lab 1: MapReduce';
var disqus_url = 'http://tinylcy.me/2017/05/03/6-824-Lab-1-MapReduce/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//tinylcy.disqus.com/count.js" async></script></div><div class="post-reward"><div id="reward_board" class="reward_bar center"><a id="btn_reward" href="javascript:;" title="打赏" class="btn_reward"></a><div class="reward_txt">好心的朋友，我是在做买卖 :)<br></div></div><div id="reward_guide" class="reward_bar center hidden"><img src="/img/wechat.png" title="微信打赏"></div><script type="text/javascript">document.getElementById('btn_reward').onclick = function(){
    $('#reward_board').addClass('hidden');
    $('#reward_guide').removeClass('hidden');
}</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://tinylcy.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/DistributedSystems/" style="font-size: 15px;">DistributedSystems</a> <a href="/tags/Life/" style="font-size: 15px;">Life</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/CSAPP/" style="font-size: 15px;">CSAPP</a> <a href="/tags/Assembly/" style="font-size: 15px;">Assembly</a> <a href="/tags/6-824/" style="font-size: 15px;">6.824</a> <a href="/tags/Unix-Linux/" style="font-size: 15px;">Unix/Linux</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/TCP-IP/" style="font-size: 15px;">TCP/IP</a> <a href="/tags/Webx/" style="font-size: 15px;">Webx</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://wdxtub.com/" title="wdxtub" target="_blank">wdxtub</a><ul></ul><a href="http://brianway.github.io/" title="brianway" target="_blank">brianway</a><ul></ul><a href="http://www.yinwang.org" title="yinwang" target="_blank">yinwang</a><ul></ul><a href="http://coolshell.cn/" title="coolshell" target="_blank">coolshell</a><ul></ul><a href="http://lucida.me/" title="lucida" target="_blank">lucida</a><ul></ul><a href="http://mindhacks.cn/" title="mindhacks" target="_blank">mindhacks</a><ul></ul><a href="http://mindwind.me/" title="mindwind" target="_blank">mindwind</a><ul></ul><a href="http://lifeofzjs.com/" title="lifeofzjs" target="_blank">lifeofzjs</a><ul></ul><a href="http://www.zreading.cn/" title="左岸读书" target="_blank">左岸读书</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a>2017 </a><a href="/." rel="nofollow">tinylcy.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>