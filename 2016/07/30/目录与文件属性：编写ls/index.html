<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>目录与文件属性：编写ls | tinylcy</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">目录与文件属性：编写ls</h1><a id="logo" href="/.">tinylcy</a><p class="description">辰洋的博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/timeline/"><i class="fa fa-envira"> 时间线</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="https://github.com/tinylcy"><i class="fa fa-github"> GitHub</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">目录与文件属性：编写ls</h1><div class="post-meta">Jul 30, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-number">1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写ls"><span class="toc-number">2.</span> <span class="toc-text">编写ls</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写ls-l"><span class="toc-number">3.</span> <span class="toc-text">编写ls -l</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#将模式字段转换成字符串"><span class="toc-number">3.1.</span> <span class="toc-text">将模式字段转换成字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#将用户-组ID转换成字符串"><span class="toc-number">3.2.</span> <span class="toc-text">将用户/组ID转换成字符串</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-number">4.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="post-content"><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p><code>ls</code>命令可以列出目录中所有文件的名字，以及这些文件的其它信息。注意，<code>ls</code>对文件和目录所做的操作是不同的，<code>ls</code>能判定参数指定的是文件还是目录。如果要自己编写<code>ls</code>，需要掌握三点：</p>
<ul>
<li>如何列出目录的内容。</li>
<li>如何读取并显示文件的属性。</li>
<li>给出一个名字，如何能够判断出它是目录还是文件。</li>
</ul>
<h2 id="编写ls"><a href="#编写ls" class="headerlink" title="编写ls"></a>编写ls</h2><p>目录是一种特殊的文件，它的内容是文件和目录的名字。与普通文件不同的是，目录文件永远不会为空，每个目录至少包含两个特殊的项目：<code>.</code>和<code>..</code>，分别代表当前目录和上一级目录。</p>
<p>什么函数可以读目录？在联机帮助中根据关键字<code>direct</code>来查找答案，用<code>grep</code>过滤出包含<code>read</code>的主题：</p>
<p><img src="/img/2016-07-30-Image 1.png" alt="Alt text"></p>
<p>其中<code>readdir (3)</code>正是需要的，查看它<code>readdir</code>的联机帮助：</p>
<p><img src="/img/2016-07-30-Image 2.png" alt="Alt text"></p>
<blockquote>
<p>The readdir_r() function is a reentrant version of readdir().  It  reads the next  directory  entry  from  the  directory stream  dirp, and returns it in the caller-allocated buffer pointed to by entry. (See NOTES for information on allocating this buffer.)  A pointer to the returned item is placed in <em>result; if the end of the directory stream  was  encountered, then NULL is instead returned in </em>result.</p>
</blockquote>
<p><code>dirent</code>结构中的成员<code>d_name</code>存放文件名，于是，可以开始编写<code>ls</code>。</p>
<p><code>ls</code>的算法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">main()</div><div class="line">    <span class="function">opendir</span></div><div class="line">    <span class="title">while</span><span class="params">(readdir)</span></div><div class="line">        print d_name</div><div class="line">    closedir</div></pre></td></tr></table></figure>
<h2 id="编写ls-l"><a href="#编写ls-l" class="headerlink" title="编写ls -l"></a>编写ls -l</h2><p><code>ls -l</code>要做两件事情，一是列出目录的内容，二是显示文件的详细信息，这实际上是两件不同的工作，目录包含文件名，文件信息则需要从另外的途径获得。先来看<code>ls -l</code>的输出：</p>
<p><img src="/img/2016-07-30-Image 3.png" alt="Alt text"></p>
<p>每行都包含<code>7</code>个字段：模式<code>(mode)</code>、链接数<code>(links)</code>、文件所有者<code>(owner)</code>、组<code>(group)</code>、大小<code>(size)</code>、最后修改时间<code>(last-modified)</code>和文件名<code>(name)</code>。如何得到文件的信息？依旧通过联机帮助：</p>
<p><img src="/img/2016-07-30-Image 4.png" alt="Alt text"></p>
<p>可以看到提取文件状态的系统调用为<code>stat (2)</code>，继续查看<code>stat (2)</code>的联机帮助：</p>
<p><img src="/img/2016-07-30-Image 5.png" alt="Alt text"></p>
<p><code>stat</code>把文件<code>path</code>的信息复制到<code>stat</code>结构的<code>buf</code>中，程序可以从<code>buf</code>中获取文件的属性，联机帮助中说明了<code>struct stat</code>的成员变量：</p>
<p><img src="/img/2016-07-30-Image 6.png" alt="Alt text"></p>
<p>如果仅仅是把<code>stat</code>中的这些信息打印出来，基本上已经实现了<code>ls -l</code>，但是存在显示的问题：打印出来的<code>mode</code>是一个八进制数，所属用户和所属组都是以<code>id</code>的形式显示。因此，为了完善<code>ls -l</code>，需要进一步处理模式、用户名和组的显示。</p>
<h3 id="将模式字段转换成字符串"><a href="#将模式字段转换成字符串" class="headerlink" title="将模式字段转换成字符串"></a>将模式字段转换成字符串</h3><p><code>st_mode</code>是一个<code>16</code>位的二进制数，文件类型和权限被编码在这个数中。其中前<code>4</code>位用作文件类型。接下来<code>3</code>位是文件的特殊属性，<code>1</code>代表具有某个属性，<code>0</code>代表没有，这<code>3</code>位分别是<code>set-user-ID</code>位、<code>set-group-ID</code>位和<code>sticky</code>位。最后的<code>9</code>位是许可权限，分为<code>3</code>组，对应于<code>3</code>种用户：文件所有者、同组用户和其它用户。</p>
<p>文件类型可以通过掩码来将其它部分置<code>0</code>，从而得到文件类型的值，在<code>&lt;sys/stat.h&gt;</code>中有如下定义：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _POSIX_SOURCE</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_IFMT	 0170000		<span class="comment">/* type of file mask */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_IFIFO	 0010000		<span class="comment">/* named pipe (fifo) */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_IFCHR	 0020000		<span class="comment">/* character special */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_IFDIR	 0040000		<span class="comment">/* directory */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_IFBLK	 0060000		<span class="comment">/* block special */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_IFREG	 0100000		<span class="comment">/* regular */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_IFLNK	 0120000		<span class="comment">/* symbolic link */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_IFSOCK 0140000		<span class="comment">/* socket */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_ISVTX	 0001000		<span class="comment">/* save swapped text even after use */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p><code>S_IFMT</code>是一个掩码，它的值是<code>0170000</code>，可以用来过滤出前<code>4</code>位表示的文件类型。<code>S_IFREG</code>代表普通文件，<code>S_IFDIR</code>代表目录文件。通过掩码把其它无关的部分置<code>0</code>，再与表示目录的代码比较，从而判定是否是一个目录。更简单的方法是使用<code>&lt;sys/stat.h&gt;</code>中的宏来判断。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_ISDIR(m)	((m &amp; 0170000) == 0040000)	<span class="comment">/* directory */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_ISCHR(m)	((m &amp; 0170000) == 0020000)	<span class="comment">/* char special */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_ISBLK(m)	((m &amp; 0170000) == 0060000)	<span class="comment">/* block special */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_ISREG(m)	((m &amp; 0170000) == 0100000)	<span class="comment">/* regular file */</span></span></div></pre></td></tr></table></figure>
<h3 id="将用户-组ID转换成字符串"><a href="#将用户-组ID转换成字符串" class="headerlink" title="将用户/组ID转换成字符串"></a>将用户/组ID转换成字符串</h3><p>我们知道，在<code>/etc/passwd</code>中包含着用户列表，但是搜索文件显然不合理。查看联机帮助，可以通过库函数<code>getpwuid</code>来得到完整的用户列表。</p>
<p><img src="/img/2016-07-30-Image 7.png" alt="Alt text"></p>
<p><code>getpwuid</code>需要<code>uid</code>作为参数，返回一个指向<code>struct passwd</code>的指针，<code>passwd</code>这个结构体定义在<code>/usr/include/pwd.h</code>中。</p>
<p><img src="/img/2016-07-30-Image 8.png" alt="Alt text"></p>
<p>类似的，用户所属的组信息保存在<code>/etc/group</code>中，通过<code>getgrgid</code>来访问组列表。联机文档如下所示。</p>
<p><img src="/img/2016-07-30-Image 9.png" alt="Alt text"></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p><code>ls</code>和<code>ls -l</code>的实现代码见<a href="https://github.com/tinylcy/LeetCode/tree/master/Linux%20Commands%20Implementation/ls" target="_blank" rel="external">Github</a>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><p><code>Unix</code>将数据存放于文件中，目录是特殊的文件，它的内容就是其中的文件和子目录的名字，还包含自己的名字，<code>Unix</code>提供一系列函数对目录操作，打开、读、定位和关闭等，但是不提供写目录的函数。</p>
</li>
<li><p>每个文件都有很多属性，程序通过系统调用<code>stat</code>来得到文件的属性。</p>
</li>
<li><p><code>Unix</code>提供的系统调用和库函数众多，要学会查阅联机帮助。</p>
</li>
</ul>
</div><div class="tags"><a href="/tags/Unix-Linux/">Unix/Linux</a></div><div class="post-nav"><a href="/2016/06/25/用机器指令和汇编指令编程（三）/" class="pre">用机器指令和汇编指令编程（三）</a><a href="/2016/08/14/TCP拥塞控制/" class="next">TCP拥塞控制</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://tinylcy.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Unix-Linux/" style="font-size: 15px;">Unix/Linux</a> <a href="/tags/Life/" style="font-size: 15px;">Life</a> <a href="/tags/6-824/" style="font-size: 15px;">6.824</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/CSAPP/" style="font-size: 15px;">CSAPP</a> <a href="/tags/Distributed-System/" style="font-size: 15px;">Distributed System</a> <a href="/tags/Assembly/" style="font-size: 15px;">Assembly</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/TCP-IP/" style="font-size: 15px;">TCP/IP</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://wdxtub.com/" title="wdxtub" target="_blank">wdxtub</a><ul></ul><a href="http://www.yinwang.org" title="yinwang" target="_blank">yinwang</a><ul></ul><a href="http://coolshell.cn/" title="coolshell" target="_blank">coolshell</a><ul></ul><a href="http://lucida.me/" title="lucida" target="_blank">lucida</a><ul></ul><a href="http://mindhacks.cn/" title="mindhacks" target="_blank">mindhacks</a><ul></ul><a href="http://www.zreading.cn/" title="左岸读书" target="_blank">左岸读书</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a>2017 </a><a href="/." rel="nofollow">tinylcy.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>